<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sky Bridge Z (HTML Full)</title>
  <style>
    :root {
      --bg1: #05081a;
      --bg2: #14072a;
      --neon: #58f0ff;
      --neon2: #b16cff;
      --panel: rgba(10, 14, 34, .72);
      --text: #eaf6ff;
      --good: #40ff90;
      --bad: #ff4d6d;
      --gold: #ffd86b;
      --muted: rgba(234, 246, 255, .7);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 800px at 50% 30%, #1b2a6b 0%, var(--bg1) 50%, var(--bg2) 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      overflow: hidden; /* Prevent scroll */
      touch-action: none; /* Prevent browser gestures */
    }

    .wrap {
      height: 100%;
      display: grid;
      place-items: center;
    }

    #game {
      width: min(520px, 100vw);
      height: min(920px, 100vh);
      aspect-ratio: 9/16;
      border-radius: 18px;
      box-shadow: 0 22px 70px rgba(0, 0, 0, .55);
      overflow: hidden;
      position: relative;
      background: radial-gradient(900px 700px at 50% 20%, rgba(90, 120, 255, .22), transparent 55%), radial-gradient(900px 700px at 60% 65%, rgba(177, 108, 255, .18), transparent 55%), linear-gradient(180deg, rgba(0, 0, 0, .25), rgba(0, 0, 0, .35));
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* HUD */
    .hud {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 14px 12px;
      gap: 10px;
    }

    .chip {
      pointer-events: none;
      background: rgba(8, 10, 24, .55);
      border: 1px solid rgba(88, 240, 255, .35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: inset 0 0 0 1px rgba(177, 108, 255, .15), 0 10px 30px rgba(0, 0, 0, .25);
    }

    .chip .label {
      opacity: .75;
      font-size: 11px;
      letter-spacing: .12em;
    }

    .chip .value {
      font-weight: 900;
      font-size: 16px;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip .value .small {
      font-size: 12px;
      opacity: .8;
      font-weight: 800;
    }

    .chipRight {
      margin-left: auto;
    }

    .centerToast {
      position: absolute;
      left: 50%;
      top: 16%;
      transform: translateX(-50%) translateY(-6px);
      font-weight: 950;
      letter-spacing: .12em;
      text-transform: uppercase;
      text-shadow: 0 6px 24px rgba(0, 0, 0, .55);
      font-size: 32px;
      opacity: 0;
      transition: opacity .18s ease, transform .18s ease;
    }

    .centerToast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .centerToast.perfect {
      color: #ffefb0;
    }

    .centerToast.failed {
      color: #ff5577;
    }

    .centerToast.combo {
      color: #ffd86b;
    }

    .cornerBar {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      display: flex;
      gap: 10px;
      pointer-events: auto;
    }

    .navBtn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(8, 10, 24, .45);
      border: 1px solid rgba(255, 255, 255, .10);
      color: rgba(234, 246, 255, .9);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      backdrop-filter: blur(8px);
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(177, 108, 255, .12), 0 10px 30px rgba(0, 0, 0, .18);
    }

    .navBtn.active {
      border-color: rgba(88, 240, 255, .45);
      box-shadow: inset 0 0 0 1px rgba(88, 240, 255, .20), 0 10px 30px rgba(0, 0, 0, .18);
    }

    .navBtn .ico {
      font-size: 16px;
      opacity: .9
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 950;
      letter-spacing: .06em;
      background: rgba(255, 216, 107, .22);
      border: 1px solid rgba(255, 216, 107, .35);
      margin-left: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(177, 108, 255, .35);
      background: rgba(16, 10, 40, .55);
      margin: 10px auto 0;
      width: fit-content;
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding: 2px 7px;
      background: rgba(255, 255, 255, .10);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .12);
    }

    /* Panels */
    .panel {
      position: absolute;
      inset: 0;
      display: none;
      place-items: center;
      padding: 16px;
      background: rgba(0, 0, 0, .35);
      backdrop-filter: blur(4px);
      pointer-events: auto;
    }

    .panel.show {
      display: grid;
    }

    .card {
      width: min(460px, 94%);
      background: var(--panel);
      border: 1px solid rgba(88, 240, 255, .25);
      border-radius: 18px;
      padding: 18px 16px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, .55), inset 0 0 0 1px rgba(177, 108, 255, .18);
    }

    .card h1 {
      margin: 0 0 10px;
      font-size: 34px;
      letter-spacing: .1em;
      text-align: center;
    }

    .sub {
      opacity: .82;
      text-align: center;
      margin: 0 0 14px;
      line-height: 1.6;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .divider {
      height: 1px;
      background: rgba(255, 255, 255, .10);
      margin: 12px 0;
    }

    .btns {
      display: grid;
      gap: 10px;
    }

    button {
      appearance: none;
      border: 0;
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 950;
      letter-spacing: .08em;
      cursor: pointer;
    }

    .btnPrimary {
      background: linear-gradient(180deg, rgba(88, 240, 255, .9), rgba(64, 255, 144, .85));
      color: #071018;
      box-shadow: 0 10px 30px rgba(64, 255, 144, .22);
    }

    .btnWarn {
      background: linear-gradient(180deg, rgba(255, 216, 107, .95), rgba(255, 160, 80, .9));
      color: #2a1400;
    }

    .btnGhost {
      background: rgba(255, 255, 255, .08);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .12);
    }

    .btnDanger {
      background: rgba(255, 77, 109, .14);
      color: rgba(255, 220, 230, .95);
      border: 1px solid rgba(255, 77, 109, .25);
    }

    .tiny {
      opacity: .72;
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
    }

    .menuTitle {
      font-size: 42px;
      text-align: center;
      margin: 0 0 6px;
      letter-spacing: .06em;
    }

    .tabs {
      display: flex;
      gap: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      padding: 6px;
      border-radius: 14px;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      padding: 10px 10px;
      border-radius: 12px;
      background: transparent;
      color: rgba(234, 246, 255, .75);
      border: 1px solid transparent;
      font-weight: 950;
    }

    .tab.active {
      background: rgba(88, 240, 255, .12);
      border-color: rgba(88, 240, 255, .22);
      color: rgba(234, 246, 255, .95);
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .item {
      background: rgba(8, 10, 24, .45);
      border: 1px solid rgba(88, 240, 255, .20);
      border-radius: 16px;
      padding: 12px;
      box-shadow: inset 0 0 0 1px rgba(177, 108, 255, .10);
    }

    .item h3 {
      margin: 0 0 6px;
      font-size: 14px;
      letter-spacing: .06em;
    }

    .item .thumb {
      height: 72px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(88, 240, 255, .18), rgba(177, 108, 255, .14));
      border: 1px solid rgba(255, 255, 255, .10);
      margin-bottom: 10px;
      display: grid;
      place-items: center;
      font-weight: 950;
      color: rgba(234, 246, 255, .85);
    }

    .priceBtn {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      background: rgba(177, 108, 255, .18);
      border: 1px solid rgba(177, 108, 255, .28);
      color: rgba(234, 246, 255, .95);
      font-weight: 950;
    }

    .priceBtn.buy {
      background: rgba(255, 216, 107, .18);
      border-color: rgba(255, 216, 107, .30);
    }

    .priceBtn.owned {
      background: rgba(64, 255, 144, .14);
      border-color: rgba(64, 255, 144, .22);
      opacity: .9;
      cursor: default;
    }

    .muted {
      opacity: .72
    }

    .switchRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      margin-bottom: 10px;
    }

    .switchRow b {
      letter-spacing: .08em;
    }

    .switch {
      width: 46px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(88, 240, 255, .22);
      background: rgba(8, 10, 24, .45);
      position: relative;
      cursor: pointer;
    }

    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(234, 246, 255, .92);
      box-shadow: 0 8px 18px rgba(0, 0, 0, .35);
    }

    .switch.on {
      background: rgba(88, 240, 255, .18);
      border-color: rgba(88, 240, 255, .38);
    }

    .switch.on .knob {
      left: 21px;
      background: rgba(88, 240, 255, .95);
    }

    input[type="range"] {
      width: 100%;
    }

    .list {
      display: grid;
      gap: 10px;
      max-height: 420px;
      overflow: auto;
      padding-right: 4px;
    }

    .rankRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
    }

    .rankRow .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .trophy {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-weight: 950;
    }

    .t1 {
      background: rgba(255, 216, 107, .20);
      border: 1px solid rgba(255, 216, 107, .32);
    }

    .t2 {
      background: rgba(230, 240, 255, .14);
      border: 1px solid rgba(230, 240, 255, .22);
    }

    .t3 {
      background: rgba(255, 160, 80, .16);
      border: 1px solid rgba(255, 160, 80, .24);
    }

    .you {
      outline: 2px solid rgba(88, 240, 255, .28);
      background: rgba(88, 240, 255, .10);
    }

    .dailyGrid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .dailyCell {
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .06);
      display: grid;
      place-items: center;
      gap: 6px;
      min-height: 84px;
      text-align: center;
      position: relative;
    }

    .dailyCell.done {
      border-color: rgba(64, 255, 144, .22);
      background: rgba(64, 255, 144, .08);
    }

    .dailyCell.locked {
      opacity: .55
    }

    .dailyCell .day {
      font-size: 12px;
      opacity: .8;
      letter-spacing: .08em;
    }

    .dailyCell .reward {
      font-weight: 950;
    }

    .dailyCell .check {
      position: absolute;
      top: 8px;
      right: 8px;
      font-weight: 950;
      color: rgba(64, 255, 144, .95);
    }

    .footerActions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .footerActions button {
      flex: 1;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="game">
      <canvas id="c"></canvas>

      <!-- HUD -->
      <div class="hud">
        <div class="topbar">
          <div class="chip" style="min-width:132px">
            <div class="label">SCORE</div>
            <div class="value"><span id="score">0</span></div>
          </div>

          <div class="chip" style="min-width:132px">
            <div class="label">COMBO</div>
            <div class="value"><span id="combo">x1</span></div>
          </div>

          <div class="chip chipRight" style="min-width:138px; text-align:right;">
            <div class="label">GEMS</div>
            <div class="value" style="justify-content:flex-end;">
              <span id="gems">0</span>
              <span class="small">‚óÜ</span>
            </div>
          </div>
        </div>

        <div class="centerToast" id="toast">PERFECT</div>

        <!-- Bottom nav (like Play/Store/Settings) -->
        <div class="cornerBar">
          <button class="navBtn active" id="navPlay">
            <div class="ico">‚ñ∂</div>Play
          </button>
          <button class="navBtn" id="navStore">
            <div class="ico">üõí</div>Store <span class="badge" id="storeBadge" style="display:none;">!</span>
          </button>
          <button class="navBtn" id="navSettings">
            <div class="ico">‚öô</div>Settings
          </button>
        </div>

        <div style="position:absolute; left:12px; bottom:74px;" class="chip">
          <div class="label">LEVEL</div>
          <div class="value" id="level">1</div>
        </div>

        <div style="position:absolute; right:12px; bottom:74px;" class="chip">
          <div class="label">SKIN</div>
          <div class="value" id="skinName">CHICK</div>
        </div>
      </div>

      <!-- Main Menu Panel (home hub) -->
      <div class="panel show" id="menuPanel">
        <div class="card">
          <div class="menuTitle">SKY BRIDGE Z</div>
          <p class="sub">Hold to extend bridge ¬∑ Release to drop</p>
          <div class="btns">
            <button class="btnPrimary" id="btnPlay">PLAY</button>
            <button class="btnGhost" id="btnCharacters">CHARACTERS</button>
            <button class="btnGhost" id="btnDaily">DAILY GIFTS <span class="badge" id="dailyBadge"
                style="display:none;">CLAIM</span></button>
            <button class="btnGhost" id="btnRanking">GLOBAL RANKING</button>
            <button class="btnGhost" id="btnInvite">INVITE FRIENDS</button>
            <button class="btnGhost" id="btnTutorial">TUTORIAL</button>
          </div>
          <div class="pill">
            <span class="kbd">Hold</span> ÎäòÎ¶¨Í∏∞
            <span style="opacity:.6">¬∑</span>
            <span class="kbd">Release</span> ÎìúÎ°≠
          </div>
          <div class="tiny">Ï†ÄÏû•: localStorage ¬∑ Í¥ëÍ≥† ÎåÄÏã† ContinueÎäî Î¨¥Î£å 1Ìöå ÎòêÎäî GemsÎ°ú Íµ¨ÌòÑ</div>
        </div>
      </div>

      <!-- Tutorial -->
      <div class="panel" id="tutorialPanel">
        <div class="card">
          <h1 style="font-size:28px;">TUTORIAL</h1>
          <p class="sub">
            1) ÌôîÎ©¥ÏùÑ <b>Í∏∏Í≤å ÎàåÎü¨</b> Îã§Î¶¨Î•º ÎäòÎ¶¨ÏÑ∏Ïöî.<br />
            2) ÏÜêÏùÑ <b>ÎñºÎ©¥</b> Îã§Î¶¨Í∞Ä Îñ®Ïñ¥ÏßëÎãàÎã§.<br />
            3) Îã§Ïùå Î∞úÌåêÏùò <b>Ï§ëÏïô(Perfect)</b>Ïóê ÎßûÏ∂îÎ©¥ ÏΩ§Î≥¥Í∞Ä Ïò¨ÎùºÍ∞ëÎãàÎã§.
          </p>
          <div class="btns">
            <button class="btnPrimary" id="btnTutOk">GOT IT!</button>
          </div>
        </div>
      </div>

      <!-- Failed -->
      <div class="panel" id="failPanel">
        <div class="card">
          <h1 style="color:var(--bad);">FAILED</h1>
          <div class="row" style="justify-content:center; gap:12px; margin-top:8px;">
            <div style="font-size:16px; opacity:.85;">SCORE:</div>
            <div style="font-size:34px; font-weight:950;" id="finalScore">0</div>
          </div>
          <div class="divider"></div>
          <div class="btns">
            <button class="btnPrimary" id="btnContinue">CONTINUE</button>
            <button class="btnWarn" id="btnRetry">RETRY</button>
            <button class="btnGhost" id="btnMainMenu">MAIN MENU</button>
          </div>
          <div class="tiny" id="continueHint">Continue: Î¨¥Î£å 1Ìöå, Ïù¥ÌõÑ 30 Gems ÏÜåÎ™®</div>
        </div>
      </div>

      <!-- Milestone -->
      <div class="panel" id="milestonePanel">
        <div class="card">
          <h1 style="font-size:26px; letter-spacing:.08em;">MILESTONE REACHED!</h1>
          <div style="text-align:center; margin: 12px 0;">
            <div style="font-size:14px; opacity:.8; letter-spacing:.14em;">LEVEL</div>
            <div style="font-size:56px; font-weight:950; color:#ffefb0; text-shadow: 0 10px 34px rgba(255,216,107,.18);"
              id="mileLevel">10</div>
          </div>
          <div class="item" style="margin-bottom:10px;">
            <div class="row">
              <div><b style="letter-spacing:.08em;">GEMS EARNED</b></div>
              <div style="font-weight:950; color: rgba(88,240,255,.95);" id="mileGems">+50 ‚óÜ</div>
            </div>
          </div>
          <div class="item" id="mileSkinBox" style="display:none;">
            <div class="row">
              <div>
                <b style="letter-spacing:.08em;">NEW SKIN UNLOCKED</b>
                <div class="muted" id="mileSkinName">NINJA</div>
              </div>
              <div style="font-weight:950;">üé≠</div>
            </div>
          </div>
          <div class="footerActions">
            <button class="btnPrimary" id="btnMileContinue">COLLECT & CONTINUE</button>
            <button class="btnGhost" id="btnMileShare">SHARE</button>
          </div>
          <div class="tiny">ShareÎäî Îç∞Î™®(ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨)Î°ú Ï≤òÎ¶¨</div>
        </div>
      </div>

      <!-- Characters -->
      <div class="panel" id="charactersPanel">
        <div class="card">
          <h1 style="font-size:28px;">CHARACTERS</h1>
          <p class="sub">Ï†êÏàò/Ï¥àÎåÄ Ï°∞Í±¥ÏúºÎ°ú Ïû†Í∏à Ìï¥Ï†ú ¬∑ ÏÑ†ÌÉù Ïãú Ïô∏Ìòï/Ìö®Í≥º Î≥ÄÍ≤Ω(Îç∞Î™®)</p>
          <div class="grid2" id="charGrid"></div>
          <div class="footerActions">
            <button class="btnGhost" id="btnCharsClose">CLOSE</button>
          </div>
        </div>
      </div>

      <!-- Store -->
      <div class="panel" id="storePanel">
        <div class="card">
          <h1 style="font-size:28px;">STORE</h1>
          <div class="tabs">
            <button class="tab active" id="tabThemes">BRIDGE THEMES</button>
            <button class="tab" id="tabTrails">TRAILS</button>
          </div>
          <div class="grid2" id="storeGrid"></div>
          <div class="divider"></div>
          <div class="btns">
            <button class="btnGhost" id="btnRecharge">RECHARGE GEMS</button>
            <button class="btnGhost" id="btnStoreClose">CLOSE</button>
          </div>
          <div class="tiny">IAPÎäî Ïõπ Îç∞Î™®Îùº ‚ÄúÍ≤∞Ï†ú ÏãúÎÆ¨Î†àÏù¥ÏÖò‚ÄùÏúºÎ°ú Ï†¨Îßå ÏßÄÍ∏â</div>
        </div>
      </div>

      <!-- Recharge Gems -->
      <div class="panel" id="rechargePanel">
        <div class="card">
          <h1 style="font-size:28px;">RECHARGE GEMS</h1>
          <div class="item">
            <div class="row">
              <div>
                <b>HANDFUL OF GEMS</b>
                <div class="muted">100 Gems</div>
              </div>
              <button class="priceBtn buy" data-pack="small">$0.99</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="item">
            <div class="row">
              <div>
                <b>BAG OF GEMS</b>
                <div class="muted">500 Gems + 50 Bonus</div>
              </div>
              <button class="priceBtn buy" data-pack="medium">$4.99</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="item" style="border-color: rgba(255,216,107,.28);">
            <div class="row">
              <div>
                <b>TREASURE CHEST</b>
                <div class="muted">2000 Gems + 300 Bonus</div>
              </div>
              <button class="priceBtn buy" data-pack="large">$19.99</button>
            </div>
          </div>
          <div class="footerActions">
            <button class="btnGhost" id="btnRechargeClose">CLOSE</button>
          </div>
          <div class="tiny">Ïã§ÏÑúÎπÑÏä§Î©¥ Stripe/Ïù∏Ïï±Í≤∞Ï†ú/PWA Billing Îì± Ïó∞Îèô ÌïÑÏöî</div>
        </div>
      </div>

      <!-- Daily Gifts -->
      <div class="panel" id="dailyPanel">
        <div class="card">
          <h1 style="font-size:28px;">DAILY GIFTS</h1>
          <p class="sub" id="dailySub">Ïò§Îäò Î≥¥ÏÉÅÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî.</p>
          <div class="dailyGrid" id="dailyGrid"></div>
          <div class="divider"></div>
          <div class="btns">
            <button class="btnPrimary" id="btnDailyClaim">CLAIM</button>
            <button class="btnGhost" id="btnDailyClose">CLOSE</button>
          </div>
          <div class="tiny">Day7: Legendary Chest(ÎåÄÎüâ Ï†¨) ¬∑ Ïó∞ÏÜç Ï∂úÏÑùÏùÄ ‚ÄúÌïòÎ£® 1Ìöå‚Äù Í∏∞Ï§Ä</div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="panel" id="rankingPanel">
        <div class="card">
          <h1 style="font-size:28px;">GLOBAL RANKING</h1>
          <p class="sub">Îç∞Î™®: Î°úÏª¨ ÏµúÍ≥†Ï†êÏù¥ Î∞òÏòÅÎêòÍ≥†, ÎÇòÎ®∏ÏßÄÎäî ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞</p>
          <div class="list" id="rankList"></div>
          <div class="divider"></div>
          <div class="btns">
            <button class="btnGhost" id="btnRankingClose">CLOSE</button>
          </div>
        </div>
      </div>

      <!-- Invite -->
      <div class="panel" id="invitePanel">
        <div class="card">
          <h1 style="font-size:28px;">INVITE FRIENDS</h1>
          <p class="sub">ÏπúÍµ¨ 3Î™Ö Ï¥àÎåÄ Ïãú <b>Galaxy Trail</b> Ïñ∏ÎùΩ<br />ÏπúÍµ¨ 1Î™ÖÎãπ <b>+50 Gems</b></p>
          <div class="item">
            <div class="row">
              <div>
                <b>INVITE 3 FRIENDS</b>
                <div class="muted" id="inviteProgress">0/3 Friends Joined</div>
              </div>
              <div style="font-weight:950;">üåå</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="btns">
            <button class="btnPrimary" id="btnInviteSim">SIMULATE FRIEND JOIN (+1)</button>
            <button class="btnGhost" id="btnInviteCopy">COPY INVITE LINK</button>
            <button class="btnGhost" id="btnInviteClose">CLOSE</button>
          </div>
          <div class="tiny">Ïã§ÏÑúÎπÑÏä§Î©¥ Î¶¨ÌçºÎü¥ ÏΩîÎìú+Îî•ÎßÅÌÅ¨+ÏÑúÎ≤Ñ Í≤ÄÏ¶ùÏúºÎ°ú Íµ¨ÌòÑ</div>
        </div>
      </div>

      <!-- Settings -->
      <div class="panel" id="settingsPanel">
        <div class="card">
          <h1 style="font-size:28px;">SETTINGS</h1>

          <div class="switchRow">
            <div><b>SOUND EFFECTS</b></div>
            <div class="switch" id="swSfx">
              <div class="knob"></div>
            </div>
          </div>
          <div class="switchRow">
            <div><b>MUSIC</b></div>
            <div class="switch" id="swMusic">
              <div class="knob"></div>
            </div>
          </div>
          <div class="switchRow">
            <div><b>HAPTIC FEEDBACK</b></div>
            <div class="switch" id="swHaptic">
              <div class="knob"></div>
            </div>
          </div>

          <div class="item">
            <div class="row" style="margin-bottom:8px;">
              <b style="letter-spacing:.08em;">CALIBRATE SENSITIVITY</b>
              <span class="muted" id="sensVal">1.00x</span>
            </div>
            <input type="range" id="sensRange" min="0.70" max="1.50" step="0.01" value="1.00" />
            <div class="row muted" style="font-size:12px; margin-top:6px;">
              <span>SLOW</span><span>FAST</span>
            </div>
          </div>

          <div class="divider"></div>
          <div class="btns">
            <button class="btnGhost" id="btnRestore">RESTORE PURCHASES (demo)</button>
            <button class="btnGhost" id="btnCredits">CREDITS</button>
            <button class="btnGhost" id="btnSettingsClose">DONE</button>
            <button class="btnDanger" id="btnWipe">WIPE ALL SAVE</button>
          </div>
          <div class="tiny">WipeÎäî localStorage Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</div>
        </div>
      </div>

      <!-- Credits -->
      <div class="panel" id="creditsPanel">
        <div class="card">
          <h1 style="font-size:28px;">CREDITS</h1>
          <p class="sub">
            Demo game made with HTML Canvas.<br />
            ÏöîÏ≤≠Ìïú UIÎäî Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ Ï∞∏Í≥†Ìï¥ Ïû¨Íµ¨ÏÑ±Ìïú ÌîÑÎ°úÌÜ†ÌÉÄÏûÖÏûÖÎãàÎã§.
          </p>
          <div class="btns">
            <button class="btnGhost" id="btnCreditsClose">CLOSE</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    (() => {
      // ------------------ Storage ------------------
      const KEY = "sbz_full_save_v1";
      const todayKey = () => {
        const d = new Date();
        // local day key
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      const defaultSave = () => ({
        gems: 120,
        seenTutorial: false,

        // gameplay
        bestScore: 0,

        // continue system
        freeContinueUsedToday: false,
        continueGemsCost: 30,

        // cosmetics ownership
        ownedThemes: { neonPulse: true, cyberGrid: false, lavaFlow: false },
        ownedTrails: { basic: true, galaxy: false }, // galaxy unlocked by invite
        equippedTheme: "neonPulse",
        equippedTrail: "basic",

        // characters
        ownedChars: { chick: true, ninja: false, rabbit: false },
        equippedChar: "chick",

        // unlock requirements
        unlock: {
          ninjaScore: 10000,
          rabbitScore: 20000
        },

        // invite
        inviteJoined: 0,

        // daily
        daily: {
          lastClaimDayKey: null,
          streak: 0, // 0..7 then loops or holds
          pending: true // computed later
        },

        // settings
        settings: {
          sfx: true,
          music: true,
          haptic: true,
          sensitivity: 1.00
        },

        // bookkeeping
        lastSeenDayKey: null
      });

      function loadSave() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return defaultSave();
          const s = JSON.parse(raw);
          // merge with defaults to be resilient
          return deepMerge(defaultSave(), s);
        } catch (e) {
          return defaultSave();
        }
      }
      function saveNow() { localStorage.setItem(KEY, JSON.stringify(save)); }

      function deepMerge(base, over) {
        if (typeof base !== "object" || base === null) return over;
        const out = Array.isArray(base) ? [...base] : { ...base };
        for (const k of Object.keys(over || {})) {
          if (base[k] && typeof base[k] === "object" && !Array.isArray(base[k]) && typeof over[k] === "object" && over[k] !== null && !Array.isArray(over[k])) {
            out[k] = deepMerge(base[k], over[k]);
          } else {
            out[k] = over[k];
          }
        }
        return out;
      }

      let save = loadSave();

      // daily/continue day rollover
      function dayRollover() {
        const t = todayKey();
        if (save.lastSeenDayKey !== t) {
          // new day
          save.lastSeenDayKey = t;
          save.freeContinueUsedToday = false;

          // daily pending if not claimed today
          save.daily.pending = (save.daily.lastClaimDayKey !== t);
          saveNow();
        }
      }
      dayRollover();

      // ------------------ Canvas setup ------------------
      const canvas = document.getElementById('c');
      const ctx = canvas.getContext('2d');

      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      function resize() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        if (!state.running) {
          state.platformY = Math.floor(rect.height * 0.72);
        }
      }
      window.addEventListener('resize', resize);

      // ------------------ UI elements ------------------
      const scoreEl = document.getElementById('score');
      const comboEl = document.getElementById('combo');
      const levelEl = document.getElementById('level');
      const gemsEl = document.getElementById('gems');
      const toastEl = document.getElementById('toast');
      const skinNameEl = document.getElementById('skinName');
      const dailyBadge = document.getElementById('dailyBadge');
      const storeBadge = document.getElementById('storeBadge');

      const menuPanel = document.getElementById('menuPanel');
      const tutorialPanel = document.getElementById('tutorialPanel');
      const failPanel = document.getElementById('failPanel');
      const milestonePanel = document.getElementById('milestonePanel');
      const charactersPanel = document.getElementById('charactersPanel');
      const storePanel = document.getElementById('storePanel');
      const rechargePanel = document.getElementById('rechargePanel');
      const dailyPanel = document.getElementById('dailyPanel');
      const rankingPanel = document.getElementById('rankingPanel');
      const invitePanel = document.getElementById('invitePanel');
      const settingsPanel = document.getElementById('settingsPanel');
      const creditsPanel = document.getElementById('creditsPanel');

      const btnPlay = document.getElementById('btnPlay');
      const btnTutorial = document.getElementById('btnTutorial');
      const btnTutOk = document.getElementById('btnTutOk');
      const btnRetry = document.getElementById('btnRetry');
      const btnMainMenu = document.getElementById('btnMainMenu');
      const btnContinue = document.getElementById('btnContinue');
      const continueHint = document.getElementById('continueHint');

      const btnCharacters = document.getElementById('btnCharacters');
      const btnCharsClose = document.getElementById('btnCharsClose');
      const charGrid = document.getElementById('charGrid');

      const navPlay = document.getElementById('navPlay');
      const navStore = document.getElementById('navStore');
      const navSettings = document.getElementById('navSettings');

      const tabThemes = document.getElementById('tabThemes');
      const tabTrails = document.getElementById('tabTrails');
      const storeGrid = document.getElementById('storeGrid');
      const btnStoreClose = document.getElementById('btnStoreClose');
      const btnRecharge = document.getElementById('btnRecharge');
      const btnRechargeClose = document.getElementById('btnRechargeClose');

      const btnDaily = document.getElementById('btnDaily');
      const btnDailyClose = document.getElementById('btnDailyClose');
      const btnDailyClaim = document.getElementById('btnDailyClaim');
      const dailyGrid = document.getElementById('dailyGrid');
      const dailySub = document.getElementById('dailySub');

      const btnRanking = document.getElementById('btnRanking');
      const btnRankingClose = document.getElementById('btnRankingClose');
      const rankList = document.getElementById('rankList');

      const btnInvite = document.getElementById('btnInvite');
      const btnInviteClose = document.getElementById('btnInviteClose');
      const btnInviteSim = document.getElementById('btnInviteSim');
      const btnInviteCopy = document.getElementById('btnInviteCopy');
      const inviteProgress = document.getElementById('inviteProgress');

      const swSfx = document.getElementById('swSfx');
      const swMusic = document.getElementById('swMusic');
      const swHaptic = document.getElementById('swHaptic');
      const sensRange = document.getElementById('sensRange');
      const sensVal = document.getElementById('sensVal');
      const btnRestore = document.getElementById('btnRestore');
      const btnCredits = document.getElementById('btnCredits');
      const btnSettingsClose = document.getElementById('btnSettingsClose');
      const btnWipe = document.getElementById('btnWipe');

      const btnCreditsClose = document.getElementById('btnCreditsClose');

      const mileLevel = document.getElementById('mileLevel');
      const mileGems = document.getElementById('mileGems');
      const mileSkinBox = document.getElementById('mileSkinBox');
      const mileSkinName = document.getElementById('mileSkinName');
      const btnMileContinue = document.getElementById('btnMileContinue');
      const btnMileShare = document.getElementById('btnMileShare');

      const finalScoreEl = document.getElementById('finalScore');

      function showOnly(panel) {
        const panels = [menuPanel, tutorialPanel, failPanel, milestonePanel, charactersPanel, storePanel, rechargePanel, dailyPanel, rankingPanel, invitePanel, settingsPanel, creditsPanel];
        panels.forEach(p => p.classList.remove('show'));
        if (panel) panel.classList.add('show');
      }
      function isAnyModalOpen() {
        const panels = [menuPanel, tutorialPanel, failPanel, milestonePanel, charactersPanel, storePanel, rechargePanel, dailyPanel, rankingPanel, invitePanel, settingsPanel, creditsPanel];
        return panels.some(p => p.classList.contains('show'));
      }
      function setNavActive(which) {
        [navPlay, navStore, navSettings].forEach(b => b.classList.remove('active'));
        if (which === "play") navPlay.classList.add('active');
        if (which === "store") navStore.classList.add('active');
        if (which === "settings") navSettings.classList.add('active');
      }

      function toast(text, kind = "combo", ms = 700) {
        toastEl.textContent = text;
        toastEl.className = "centerToast show " + kind;
        clearTimeout(toast._t);
        toast._t = setTimeout(() => toastEl.className = "centerToast", ms);
      }

      // ------------------ Audio/Haptic (lightweight demo) ------------------
      let audioCtx = null;
      function beep(freq = 880, dur = 0.06, type = "sine", vol = 0.03) {
        if (!save.settings.sfx) return;
        try {
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = type; o.frequency.value = freq;
          g.gain.value = vol;
          o.connect(g); g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + dur);
        } catch (e) { }
      }
      function haptic(ms = 20) {
        if (!save.settings.haptic) return;
        if (navigator.vibrate) navigator.vibrate(ms);
      }

      // ------------------ Catalog ------------------
      const CHARACTERS = [
        { id: "chick", name: "CHICK", unlock: { type: "free" }, color: "#ffd86b" },
        { id: "ninja", name: "NINJA", unlock: { type: "score", value: () => save.unlock.ninjaScore }, color: "#58f0ff" },
        { id: "rabbit", name: "RABBIT", unlock: { type: "score", value: () => save.unlock.rabbitScore }, color: "#ff8bd6" },
      ];

      const THEMES = [
        { id: "neonPulse", name: "Neon Pulse", price: 500, thumb: "NEON" },
        { id: "cyberGrid", name: "Cyber Grid", price: 750, thumb: "GRID" },
        { id: "lavaFlow", name: "Lava Flow", price: 1000, thumb: "LAVA" },
      ];

      const TRAILS = [
        { id: "basic", name: "Basic Trail", price: 0, thumb: "BASIC" },
        { id: "galaxy", name: "Galaxy Trail", price: 0, thumb: "GALAXY", unlock: { type: "invite", value: 3 } },
      ];

      // ------------------ Game State ------------------
      const state = {
        running: false,
        holding: false,
        dropping: false,
        walking: false,
        charX: 0,
        charTargetX: 0,
        // tuning (sensitivity affects grow speed)
        baseGrowSpeed: 420,       // px/s
        rotateSpeed: 520,         // deg/s
        // gameplay
        score: 0,
        combo: 1,
        level: 1,
        streakPerfect: 0,
        // continue
        continuedThisRun: false,

        // world
        camX: 0,
        targetCamX: 0,
        platformY: 0,
        // bridge
        bridgeLen: 0,
        bridgeAngle: 0, // 0=up, 90=flat
        bridgeDropVel: 0,
        // platforms
        platforms: [],
        curIndex: 0,
        // stars
        stars: []
      };

      function effectiveGrowSpeed() {
        return state.baseGrowSpeed * (save.settings.sensitivity || 1.0);
      }

      function resetRun() {
        state.running = true;
        state.holding = false;
        state.dropping = false;
        state.walking = false;

        state.score = 0;
        state.combo = 1;
        state.level = 1;
        state.streakPerfect = 0;
        state.continuedThisRun = false;

        state.camX = 0;
        state.targetCamX = 0;
        state.bridgeLen = 0;
        state.bridgeAngle = 0;
        state.bridgeDropVel = 0;
        state.platforms = [];
        state.curIndex = 0;

        const W = canvas.getBoundingClientRect().width;
        const H = canvas.getBoundingClientRect().height;
        state.platformY = Math.floor(H * 0.72);

        const p0 = makePlatform(70, state.platformY, 110);
        const p1 = makeNextPlatform(p0);
        state.platforms.push(p0, p1);
        
        // Character starts on first platform
        state.charX = p0.x + p0.w - 30; // slightly back from edge

        state.stars = Array.from({ length: 80 }, () => ({
          x: Math.random() * W * 1.8,
          y: Math.random() * H,
          r: 0.8 + Math.random() * 1.6,
          a: 0.25 + Math.random() * 0.75
        }));

        syncHUD();
      }

      function syncHUD() {
        scoreEl.textContent = state.score.toLocaleString();
        comboEl.textContent = "x" + state.combo;
        levelEl.textContent = state.level;
        gemsEl.textContent = save.gems.toLocaleString();
        skinNameEl.textContent = (CHARACTERS.find(c => c.id === save.equippedChar)?.name || "CHICK");
        dailyBadge.style.display = canClaimDaily() ? "inline-flex" : "none";

        // show store badge if something unlockable new (galaxy trail not unlocked but can be via invite)
        const canUnlockGalaxy = save.inviteJoined >= 3 && !save.ownedTrails.galaxy;
        storeBadge.style.display = canUnlockGalaxy ? "inline-flex" : "none";
      }

      // ------------------ Platforms ------------------
      function makePlatform(x, y, w) {
        return { x, y, w, h: 18, perfectW: Math.max(18, Math.min(46, w * 0.22)) };
      }
      function makeNextPlatform(prev) {
        // difficulty scaling by level
        // Reduced gap and width to fit more platforms on screen
        const gap = rand(40, 140) * (1 + Math.min(0.9, (state.level - 1) * 0.05));
        const w = rand(50, 100) * (1 - Math.min(0.35, (state.level - 1) * 0.02));
        return makePlatform(prev.x + prev.w + gap, prev.y, w);
      }
      function curPlatform() { return state.platforms[state.curIndex]; }
      function nextPlatform() { return state.platforms[state.curIndex + 1]; }

      // ------------------ Input ------------------
      function canInput() {
        return state.running && !state.dropping && !state.walking && !isAnyModalOpen();
      }
      function onHoldStart() {
        if (!canInput()) return;
        state.holding = true;
        state.bridgeLen = 0;
        state.bridgeAngle = 0;
        state.bridgeDropVel = 0;
        beep(740, .04, "triangle", .02);
      }
      function onHoldEnd() {
        if (!canInput()) return;
        if (!state.holding) return;
        state.holding = false;
        state.dropping = true;
        beep(520, .05, "sine", .02);
      }
      canvas.addEventListener('pointerdown', (e) => { e.preventDefault(); onHoldStart(); });
      window.addEventListener('pointerup', () => onHoldEnd());

      // ------------------ Game flow: scoring, milestone, unlocks ------------------
      function maybeUnlockCharactersByScore() {
        if (save.bestScore >= save.unlock.ninjaScore) save.ownedChars.ninja = true;
        if (save.bestScore >= save.unlock.rabbitScore) save.ownedChars.rabbit = true;
      }

      function grantGems(n) {
        save.gems = Math.max(0, (save.gems | 0) + (n | 0));
        saveNow();
        syncHUD();
      }

      function fail() {
        state.running = false;

        // best score update
        if (state.score > save.bestScore) {
          save.bestScore = state.score;
          maybeUnlockCharactersByScore();
          saveNow();
        }

        finalScoreEl.textContent = state.score.toLocaleString();
        toast("FAILED", "failed", 900);
        haptic(30);
        beep(180, .08, "sawtooth", .03);

        updateContinueHint();
        showOnly(failPanel);
        setNavActive("play");
      }

      function updateContinueHint() {
        dayRollover();
        const free = !save.freeContinueUsedToday && !state.continuedThisRun;
        if (free) {
          continueHint.textContent = "Continue: Î¨¥Î£å 1Ìöå (Ïò§Îäò ÏïÑÏßÅ ÏÇ¨Ïö© ÏïàÌï®)";
          btnContinue.textContent = "CONTINUE (FREE)";
        } else {
          continueHint.textContent = `Continue: ${save.continueGemsCost} Gems ÏÜåÎ™®`;
          btnContinue.textContent = `CONTINUE (-${save.continueGemsCost}‚óÜ)`;
        }
      }

      function continueFromFail() {
        dayRollover();
        if (state.continuedThisRun) {
          // prevent infinite continues for MVP
          toast("CONTINUE LIMIT", "failed", 700);
          return;
        }

        const free = !save.freeContinueUsedToday;
        if (!free) {
          if (save.gems < save.continueGemsCost) {
            toast("NOT ENOUGH GEMS", "failed", 900);
            beep(220, .08, "square", .02);
            return;
          }
          save.gems -= save.continueGemsCost;
        } else {
          save.freeContinueUsedToday = true;
        }
        state.continuedThisRun = true;
        saveNow();

        // revive: give a safe setup
        state.running = true;
        state.holding = false;
        state.dropping = false;
        state.walking = false;

        // soften penalty
        state.combo = 1;
        state.streakPerfect = 0;

        // reposition: keep current platform and regenerate next with moderate gap
        const cp = curPlatform() || makePlatform(70, state.platformY, 110);
        const newNext = makePlatform(cp.x + cp.w + rand(110, 170), cp.y, rand(90, 140));
        state.platforms[state.curIndex] = cp;
        state.platforms[state.curIndex + 1] = newNext;
        // Pre-generate more platforms
        state.platforms.push(makeNextPlatform(newNext));
        state.platforms.push(makeNextPlatform(state.platforms[state.platforms.length-1]));
        
        state.charX = cp.x + cp.w - 30;

        state.bridgeLen = 0;
        state.bridgeAngle = 0;
        state.bridgeDropVel = 0;
        state.targetCamX = cp.x - 40; // Shift left to see more

        showOnly(null);
        syncHUD();
        toast("CONTINUE!", "combo", 700);
        haptic(20);
        beep(880, .05, "triangle", .02);
      }

      function showMilestone(levelReached, gemsAward, newSkinId = null) {
        mileLevel.textContent = levelReached;
        mileGems.textContent = `+${gemsAward} ‚óÜ`;
        if (newSkinId) {
          mileSkinBox.style.display = "block";
          mileSkinName.textContent = (CHARACTERS.find(c => c.id === newSkinId)?.name || newSkinId).toUpperCase();
        } else {
          mileSkinBox.style.display = "none";
        }
        showOnly(milestonePanel);
      }

      function success(isPerfect) {
        // scoring
        const base = isPerfect ? 150 : 100;

        if (isPerfect) {
          state.streakPerfect++;
          state.combo = Math.min(10, 1 + state.streakPerfect); // x2..x10
          state.score += Math.floor(base * state.combo);
          toast(`PERFECT  x${state.combo}`, "perfect", 700);
          beep(980, .04, "sine", .02);
          haptic(12);
        } else {
          state.streakPerfect = 0;
          state.combo = 1;
          state.score += base;
          toast("GOOD", "combo", 450);
          beep(660, .03, "triangle", .015);
        }

        // small gameplay gems drip
        const drip = isPerfect ? 2 : 1;
        grantGems(drip);

        // Start walking
        state.walking = true;
        const np = nextPlatform();
        // Target is near the end of the next platform
        state.charTargetX = np.x + np.w - 30; 
        
        syncHUD();
      }
      
      function finishCrossing() {
        state.walking = false;
        
        // progress
        state.curIndex++;
        state.level++;

        // milestones like screenshot: level 10 -> +50 gems and unlock ninja
        if (state.level === 10) {
          const award = 50;
          grantGems(award);
          if (!save.ownedChars.ninja) {
            save.ownedChars.ninja = true;
            saveNow();
            showMilestone(10, award, "ninja");
          } else {
            showMilestone(10, award, null);
          }
          // pause run behind milestone
          state.running = false;
        } else if (state.level % 25 === 0) {
          const award = 100;
          grantGems(award);
          showMilestone(state.level, award, null);
          state.running = false;
        }

        // ensure platforms ahead (Keep 5 ahead)
        while (state.platforms.length < state.curIndex + 5) {
          state.platforms.push(makeNextPlatform(state.platforms[state.platforms.length - 1]));
        }

        // move camera
        const cp = curPlatform();
        state.targetCamX = cp.x - 40; // Shift left to see more

        // reset bridge
        state.bridgeLen = 0;
        state.bridgeAngle = 0;
        state.bridgeDropVel = 0;

        syncHUD();
      }
      
      function finishCrossing() {
        state.walking = false;
        
        // progress
        state.curIndex++;
        state.level++;

        // milestones like screenshot: level 10 -> +50 gems and unlock ninja
        if (state.level === 10) {
          const award = 50;
          grantGems(award);
          if (!save.ownedChars.ninja) {
            save.ownedChars.ninja = true;
            saveNow();
            showMilestone(10, award, "ninja");
          } else {
            showMilestone(10, award, null);
          }
          // pause run behind milestone
          state.running = false;
        } else if (state.level % 25 === 0) {
          const award = 100;
          grantGems(award);
          showMilestone(state.level, award, null);
          state.running = false;
        }

        // ensure platforms ahead
        while (state.platforms.length < state.curIndex + 3) {
          state.platforms.push(makeNextPlatform(state.platforms[state.platforms.length - 1]));
        }

        // move camera
        const cp = curPlatform();
        state.targetCamX = cp.x - 70;

        // reset bridge
        state.bridgeLen = 0;
        state.bridgeAngle = 0;
        state.bridgeDropVel = 0;

        syncHUD();
      }

      function evaluateLanding() {
        const cp = curPlatform();
        const np = nextPlatform();
        const pivotX = cp.x + cp.w;
        const endX = pivotX + state.bridgeLen;

        const npLeft = np.x;
        const npRight = np.x + np.w;

        if (endX < npLeft || endX > npRight) {
          fail();
          return;
        }

        const center = np.x + np.w / 2;
        const half = np.perfectW / 2;
        const isPerfect = (endX >= center - half) && (endX <= center + half);
        success(isPerfect);
      }

      // ------------------ Rendering ------------------
      function drawGlowRect(x, y, w, h, color, glow = 14, alpha = 1) {
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.shadowColor = color;
        ctx.shadowBlur = glow;
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
        ctx.restore();
      }

      function themeColors() {
        const t = save.equippedTheme;
        if (t === "cyberGrid") {
          return { frame: "rgba(64,255,144,.55)", glow: "rgba(64,255,144,.85)", perfect: "rgba(88,240,255,.24)" };
        }
        if (t === "lavaFlow") {
          return { frame: "rgba(255,160,80,.60)", glow: "rgba(255,120,60,.9)", perfect: "rgba(255,216,107,.24)" };
        }
        return { frame: "rgba(88,240,255,.55)", glow: "rgba(88,240,255,.9)", perfect: "rgba(255,216,107,.18)" };
      }

      function trailColor() {
        const t = save.equippedTrail;
        if (t === "galaxy") return "rgba(177,108,255,.9)";
        return "rgba(88,240,255,.75)";
      }

      function drawPlatform(p) {
        const x = p.x - state.camX;
        const y = p.y;
        const col = themeColors();

        ctx.fillStyle = "rgba(6,10,26,.85)";
        ctx.fillRect(x, y, p.w, p.h);

        ctx.strokeStyle = col.frame;
        ctx.lineWidth = 2;
        ctx.strokeRect(x + 1, y + 1, p.w - 2, p.h - 2);

        drawGlowRect(x + 6, y + 6, p.w - 12, p.h - 12, col.glow.replace(".9", ".12"), 10, 1);

        // perfect zone
        const cz = x + p.w / 2 - p.perfectW / 2;
        ctx.fillStyle = col.perfect;
        ctx.fillRect(cz, y + 2, p.perfectW, p.h - 4);
        drawGlowRect(cz, y + 2, p.perfectW, p.h - 4, "rgba(255,216,107,.30)", 12, 0.55);
      }

      function drawBridge() {
        const cp = curPlatform();
        const pivotX = cp.x + cp.w - state.camX;
        const pivotY = cp.y;
        const thickness = 8;

        ctx.save();
        ctx.translate(pivotX, pivotY);
        ctx.rotate(degToRad(state.bridgeAngle));

        const tcol = trailColor();

        // trail glow line
        ctx.shadowColor = tcol;
        ctx.shadowBlur = 18;
        ctx.fillStyle = "rgba(235,250,255,.95)";
        ctx.fillRect(-thickness / 2, -state.bridgeLen, thickness, state.bridgeLen);

        // add faint colored overlay
        ctx.globalAlpha = 0.35;
        ctx.fillStyle = tcol;
        ctx.fillRect(-thickness / 2, -state.bridgeLen, thickness, state.bridgeLen);
        ctx.restore();
      }

      // ------------------ Character & Physics Tuning ------------------
      const PHYSICS = {
        gravity: 2800, // degrees/s^2 for bridge
        walkSpeed: 320, // px/s
        bounceHeight: 14,
        bounceFreq: 0.15
      };

      function drawCharacterMarker() {
        const cp = curPlatform();
        if (!cp) return;
        
        // Calculate bounce based on character world position
        // Only bounce when moving (walking)
        const bounce = state.walking
          ? Math.abs(Math.sin(state.charX * PHYSICS.bounceFreq) * PHYSICS.bounceHeight)
          : 0;

        const size = 28;
        // Use exact character world position
        // If charX is not initialized yet (safety), fallback to platform end
        const worldX = state.charX || (cp.x + cp.w - 30);
        
        const x = worldX - state.camX; // Screen X
        const y = cp.y - size - bounce;

        const ch = CHARACTERS.find(c => c.id === save.equippedChar) || CHARACTERS[0];
        
        ctx.save();
        
        // Body
        ctx.shadowColor = ch.color;
        ctx.shadowBlur = 15;
        ctx.fillStyle = ch.color;
        ctx.fillRect(x, y, size, size);

        // Highlight/Shading (subtle)
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(x, y, size, size*0.2);

        // Eyes (White)
        ctx.shadowBlur = 0;
        ctx.fillStyle = "white";
        ctx.fillRect(x + size * 0.55, y + size * 0.25, size * 0.3, size * 0.3);

        // Pupil (Black)
        ctx.fillStyle = "#111";
        ctx.fillRect(x + size * 0.65, y + size * 0.35, size * 0.12, size * 0.12);

        ctx.restore();
      }

      function drawBackground() {
        const W = canvas.getBoundingClientRect().width;
        const H = canvas.getBoundingClientRect().height;

        // stars parallax
        ctx.save();
        for (const s of state.stars) {
          const px = (s.x - state.camX * 0.15) % (W * 2);
          const x = px < 0 ? px + W * 2 : px;
          ctx.globalAlpha = s.a;
          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.arc(x, s.y, s.r, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();

        // horizon grid
        const horizonY = Math.floor(H * 0.53);
        ctx.save();
        ctx.strokeStyle = themeColors().frame.replace(".55", ".35");
        ctx.lineWidth = 1;

        const step = 26;
        for (let y = horizonY; y < H; y += step) {
          const t = (y - horizonY) / (H - horizonY);
          ctx.globalAlpha = 0.06 + t * 0.28;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(W, y);
          ctx.stroke();
        }

        ctx.globalAlpha = 0.22;
        for (let i = 0; i < 14; i++) {
          const x = (i / 13) * W;
          ctx.beginPath();
          ctx.moveTo(x, horizonY);
          ctx.lineTo(W / 2 + (x - W / 2) * 1.8, H);
          ctx.stroke();
        }
        ctx.restore();
      }

      function render() {
        const W = canvas.getBoundingClientRect().width;
        const H = canvas.getBoundingClientRect().height;
        ctx.clearRect(0, 0, W, H);

        drawBackground();

        // platforms
        for (let i = Math.max(0, state.curIndex - 1); i < state.curIndex + 4; i++) {
          const p = state.platforms[i];
          if (!p) continue;
          drawPlatform(p);
        }

        if (state.running) {
          drawBridge();
          drawCharacterMarker();
        }

        // vignette
        ctx.save();
        const g = ctx.createRadialGradient(W / 2, H / 2, 120, W / 2, H / 2, Math.max(W, H));
        g.addColorStop(0, "rgba(0,0,0,0)");
        g.addColorStop(1, "rgba(0,0,0,.45)");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, W, H);
        ctx.restore();
      }

      // ------------------ Loop ------------------
      let last = performance.now();
      function loop(now) {
        const dt = Math.min(0.033, (now - last) / 1000);
        last = now;

        // camera ease
        // If walking, camera follows character smoothly
        if (state.walking) {
          const desiredCamX = state.charX - 80; // keep char somewhat left
          state.camX += (desiredCamX - state.camX) * (1 - Math.pow(0.001, dt));
        } else {
          state.camX += (state.targetCamX - state.camX) * (1 - Math.pow(0.001, dt));
        }

        if (state.running) {
          if (state.walking) {
            state.charX += PHYSICS.walkSpeed * dt;
            if (state.charX >= state.charTargetX) {
              state.charX = state.charTargetX;
              finishCrossing();
            }
          }
          else if (state.holding) {
            state.bridgeLen += effectiveGrowSpeed() * dt;
            state.bridgeLen = Math.min(state.bridgeLen, 560);
          }
          if (state.dropping) {
            state.bridgeDropVel += PHYSICS.gravity * dt;
            state.bridgeAngle += state.bridgeDropVel * dt;
            if (state.bridgeAngle >= 90) {
              state.bridgeAngle = 90;
              state.dropping = false;
              state.bridgeDropVel = 0;
              // Add a small shake or impact effect here if desired
              evaluateLanding();
            }
          }
        }

        render();
        requestAnimationFrame(loop);
      }

      // ------------------ Daily gifts ------------------
      const DAILY_REWARDS = [
        { day: 1, gems: 20 },
        { day: 2, gems: 25 },
        { day: 3, gems: 30 },
        { day: 4, gems: 35 },
        { day: 5, gems: 40 },
        { day: 6, gems: 45 },
        { day: 7, gems: 150, legendary: true },
      ];

      function canClaimDaily() {
        dayRollover();
        return save.daily.lastClaimDayKey !== todayKey();
      }

      function buildDailyUI() {
        const streak = save.daily.streak; // how many already claimed in current cycle
        dailyGrid.innerHTML = "";

        DAILY_REWARDS.forEach((r, idx) => {
          const dayNum = r.day;
          const cell = document.createElement("div");
          cell.className = "dailyCell";

          // Determine state
          // Next claim day is streak+1 (wrap after 7)
          const nextDay = (streak % 7) + 1;
          const isDoneInCycle = dayNum <= (streak % 7) && save.daily.lastClaimDayKey !== null;
          const isNext = dayNum === nextDay;

          if (isDoneInCycle) cell.classList.add("done");
          if (!isDoneInCycle && !isNext) cell.classList.add("locked");

          cell.innerHTML = `
        <div class="day">Day ${dayNum}</div>
        <div class="reward">${r.legendary ? "LEGENDARY" : "+" + r.gems + " ‚óÜ"}</div>
        ${isDoneInCycle ? `<div class="check">‚úì</div>` : ""}
      `;
          dailyGrid.appendChild(cell);
        });

        const can = canClaimDaily();
        dailySub.textContent = can ? "Ïò§Îäò Î≥¥ÏÉÅÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî." : "Ïò§Îäò Î≥¥ÏÉÅÏùÄ Ïù¥ÎØ∏ Î∞õÏïòÏñ¥Ïöî. ÎÇ¥Ïùº Îã§Ïãú Ïò§ÏÑ∏Ïöî.";
        btnDailyClaim.disabled = !can;
        btnDailyClaim.style.opacity = can ? "1" : "0.55";
      }

      function claimDaily() {
        if (!canClaimDaily()) return;

        // update streak (if missed a day, reset; for MVP we treat missing as reset)
        const last = save.daily.lastClaimDayKey;
        const t = todayKey();
        let newStreak = save.daily.streak || 0;
        if (last) {
          const lastDate = new Date(last + "T00:00:00");
          const nowDate = new Date(t + "T00:00:00");
          const diffDays = Math.round((nowDate - lastDate) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            newStreak += 1;
          } else {
            newStreak = 0; // reset cycle
          }
        } else {
          newStreak = 0;
        }

        // claim day is nextDay
        const claimDay = (newStreak % 7) + 1;
        const reward = DAILY_REWARDS.find(r => r.day === claimDay);

        // apply
        save.daily.streak = newStreak + 1;
        save.daily.lastClaimDayKey = t;
        save.daily.pending = false;

        grantGems(reward.gems);
        saveNow();
        syncHUD();

        toast(`DAILY +${reward.gems}‚óÜ`, "combo", 800);
        beep(900, .05, "triangle", .02);
        haptic(18);

        buildDailyUI();
      }

      // ------------------ Ranking (local + dummy) ------------------
      const DUMMY_NAMES = ["NeonPioneer_X", "CosmicBuilder77", "StarCrosser99", "NovaArchitect", "GalacticBridge", "AstroJumper", "DeepSpaceDrifter", "VoidWalkerZ", "SkyRunner_19", "PulsePilot"];
      function buildRankingUI() {
        const yourName = "SkyMaster_42";
        const yourScore = save.bestScore;

        const rows = [];
        // generate dummy scores higher and around
        for (let i = 0; i < 8; i++) {
          const base = 9000000 - i * 1100000;
          const noise = Math.floor(rand(-90000, 90000));
          rows.push({ name: DUMMY_NAMES[i], score: Math.max(1000, base + noise) });
        }
        rows.push({ name: yourName, score: yourScore, you: true });

        rows.sort((a, b) => b.score - a.score);
        const yourRank = rows.findIndex(r => r.you) + 1;

        rankList.innerHTML = "";
        rows.slice(0, 12).forEach((r, idx) => {
          const row = document.createElement("div");
          row.className = "rankRow" + (r.you ? " you" : "");
          const trophyClass = idx === 0 ? "t1" : idx === 1 ? "t2" : idx === 2 ? "t3" : "";
          const trophy = idx < 3 ? `<div class="trophy ${trophyClass}">${idx + 1}</div>` : `<div class="trophy" style="background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">${idx + 1}</div>`;
          row.innerHTML = `
        <div class="left">
          ${trophy}
          <div>
            <div style="font-weight:950;">${r.name}</div>
            ${r.you ? `<div class="muted">YOUR RANK: ${yourRank}</div>` : `<div class="muted">GLOBAL</div>`}
          </div>
        </div>
        <div style="font-weight:950;">${Number(r.score).toLocaleString()}</div>
      `;
          rankList.appendChild(row);
        });
      }

      // ------------------ Characters UI ------------------
      function buildCharactersUI() {
        charGrid.innerHTML = "";
        CHARACTERS.forEach(c => {
          const owned = !!save.ownedChars[c.id];
          const equipped = save.equippedChar === c.id;

          let unlockText = "Unlocked";
          if (!owned) {
            if (c.unlock.type === "score") {
              unlockText = `Unlock at ${c.unlock.value().toLocaleString()} points`;
            } else {
              unlockText = "Locked";
            }
          }

          const cell = document.createElement("div");
          cell.className = "item";
          cell.innerHTML = `
        <div class="thumb" style="background: linear-gradient(135deg, ${c.color}22, rgba(177,108,255,.14)); border-color: rgba(255,255,255,.10);">
          ${c.name}
        </div>
        <h3>${c.name}</h3>
        <div class="muted" style="font-size:12px; margin-bottom:10px;">${unlockText}</div>
        <button class="priceBtn ${equipped ? "owned" : owned ? "buy" : ""}" ${owned ? "" : "disabled"} style="${owned ? "" : "opacity:.55; cursor:not-allowed;"}">
          ${equipped ? "SELECTED" : owned ? "SELECT" : "LOCKED"}
        </button>
      `;
          const btn = cell.querySelector("button");
          if (owned && !equipped) {
            btn.addEventListener("click", () => {
              save.equippedChar = c.id;
              saveNow();
              syncHUD();
              buildCharactersUI();
              toast(`SELECTED ${c.name}`, "combo", 600);
              beep(860, .04, "triangle", .02);
            });
          }
          charGrid.appendChild(cell);
        });
      }

      // ------------------ Store UI ------------------
      let storeTab = "themes";
      function setStoreTab(tab) {
        storeTab = tab;
        tabThemes.classList.toggle("active", tab === "themes");
        tabTrails.classList.toggle("active", tab === "trails");
        buildStoreUI();
      }
      function buildStoreUI() {
        storeGrid.innerHTML = "";

        if (storeTab === "themes") {
          THEMES.forEach(t => {
            const owned = !!save.ownedThemes[t.id];
            const equipped = save.equippedTheme === t.id;
            const cell = document.createElement("div");
            cell.className = "item";
            cell.innerHTML = `
          <div class="thumb">${t.thumb}</div>
          <h3>${t.name}</h3>
          <div class="muted" style="font-size:12px; margin-bottom:10px;">${owned ? "Owned" : `${t.price} Gems`}</div>
          <button class="priceBtn ${equipped ? "owned" : owned ? "buy" : "buy"}">
            ${equipped ? "EQUIPPED" : owned ? "EQUIP" : `BUY (${t.price}‚óÜ)`}
          </button>
        `;
            const btn = cell.querySelector("button");
            btn.addEventListener("click", () => {
              if (!owned) {
                if (save.gems < t.price) {
                  toast("NOT ENOUGH GEMS", "failed", 900);
                  beep(220, .08, "square", .02);
                  return;
                }
                save.gems -= t.price;
                save.ownedThemes[t.id] = true;
                save.equippedTheme = t.id;
                saveNow();
                syncHUD();
                toast(`BOUGHT ${t.name}`, "combo", 700);
                beep(820, .06, "triangle", .02);
                haptic(15);
              } else {
                save.equippedTheme = t.id;
                saveNow();
                syncHUD();
                toast(`EQUIPPED ${t.name}`, "combo", 600);
                beep(740, .04, "triangle", .02);
              }
              buildStoreUI();
            });
            storeGrid.appendChild(cell);
          });
        } else {
          TRAILS.forEach(t => {
            const owned = !!save.ownedTrails[t.id];
            const equipped = save.equippedTrail === t.id;

            let status = owned ? "Owned" : "Locked";
            let action = owned ? (equipped ? "EQUIPPED" : "EQUIP") : "LOCKED";
            let disabled = !owned;

            // unlockable by invite
            if (t.unlock?.type === "invite") {
              const canUnlock = save.inviteJoined >= t.unlock.value;
              status = owned ? "Owned" : canUnlock ? "Unlocked! (Claim in Store)" : `Invite ${t.unlock.value} friends`;
              if (!owned && canUnlock) {
                action = "CLAIM";
                disabled = false;
              }
            } else if (t.price === 0) {
              status = "Owned";
              save.ownedTrails[t.id] = true; // basic always owned
              saveNow();
              disabled = false;
              action = equipped ? "EQUIPPED" : "EQUIP";
            }

            const cell = document.createElement("div");
            cell.className = "item";
            cell.innerHTML = `
          <div class="thumb">${t.thumb}</div>
          <h3>${t.name}</h3>
          <div class="muted" style="font-size:12px; margin-bottom:10px;">${status}</div>
          <button class="priceBtn ${equipped ? "owned" : (owned ? "buy" : "")}" ${disabled ? "disabled" : ""} style="${disabled ? "opacity:.55; cursor:not-allowed;" : ""}">
            ${action}
          </button>
        `;
            const btn = cell.querySelector("button");

            if (!disabled) {
              btn.addEventListener("click", () => {
                if (!owned) {
                  // claim
                  save.ownedTrails[t.id] = true;
                  save.equippedTrail = t.id;
                  saveNow();
                  syncHUD();
                  toast(`CLAIMED ${t.name}`, "combo", 700);
                  beep(900, .06, "triangle", .02);
                  haptic(18);
                } else {
                  save.equippedTrail = t.id;
                  saveNow();
                  syncHUD();
                  toast(`EQUIPPED ${t.name}`, "combo", 600);
                  beep(740, .04, "triangle", .02);
                }
                buildStoreUI();
              });
            }

            storeGrid.appendChild(cell);
          });
        }
      }

      // ------------------ Invite ------------------
      function refreshInviteUI() {
        inviteProgress.textContent = `${save.inviteJoined}/3 Friends Joined`;
      }

      async function copyInviteLink() {
        const url = location.href.split("#")[0] + "#ref=SkyMaster_42";
        try {
          await navigator.clipboard.writeText(url);
          toast("LINK COPIED", "combo", 700);
        } catch (e) {
          // fallback
          prompt("Copy invite link:", url);
        }
      }

      // ------------------ Settings UI ------------------
      function setSwitch(el, on) {
        el.classList.toggle("on", !!on);
      }
      function refreshSettingsUI() {
        setSwitch(swSfx, save.settings.sfx);
        setSwitch(swMusic, save.settings.music);
        setSwitch(swHaptic, save.settings.haptic);
        sensRange.value = String(save.settings.sensitivity ?? 1.0);
        sensVal.textContent = `${(save.settings.sensitivity ?? 1.0).toFixed(2)}x`;
      }
      function toggleSwitch(key) {
        save.settings[key] = !save.settings[key];
        saveNow();
        refreshSettingsUI();
        syncHUD();
      }

      // ------------------ Navigation / Buttons ------------------
      function openMenu() {
        showOnly(menuPanel);
        setNavActive("play");
        state.running = false;
        syncHUD();
      }

      btnPlay.addEventListener('click', () => {
        showOnly(null);
        setNavActive("play");
        dayRollover();
        if (!save.seenTutorial) {
          showOnly(tutorialPanel);
          save.seenTutorial = true;
          saveNow();
        } else {
          resetRun();
        }
      });

      btnTutorial.addEventListener('click', () => showOnly(tutorialPanel));
      btnTutOk.addEventListener('click', () => { showOnly(null); resetRun(); });

      btnRetry.addEventListener('click', () => { showOnly(null); resetRun(); });
      btnMainMenu.addEventListener('click', () => openMenu());
      btnContinue.addEventListener('click', () => continueFromFail());

      btnCharacters.addEventListener('click', () => { buildCharactersUI(); showOnly(charactersPanel); });
      btnCharsClose.addEventListener('click', () => { showOnly(menuPanel); });

      btnDaily.addEventListener('click', () => { buildDailyUI(); showOnly(dailyPanel); });
      btnDailyClose.addEventListener('click', () => showOnly(menuPanel));
      btnDailyClaim.addEventListener('click', () => claimDaily());

      btnRanking.addEventListener('click', () => { buildRankingUI(); showOnly(rankingPanel); });
      btnRankingClose.addEventListener('click', () => showOnly(menuPanel));

      btnInvite.addEventListener('click', () => { refreshInviteUI(); showOnly(invitePanel); });
      btnInviteClose.addEventListener('click', () => showOnly(menuPanel));
      btnInviteSim.addEventListener('click', () => {
        if (save.inviteJoined >= 3) {
          toast("ALREADY 3/3", "combo", 650);
          return;
        }
        save.inviteJoined++;
        grantGems(50);
        saveNow();
        refreshInviteUI();
        syncHUD();
        toast("+50‚óÜ FRIEND JOINED", "combo", 800);
        beep(940, .06, "triangle", .02);
        haptic(18);
      });
      btnInviteCopy.addEventListener('click', () => copyInviteLink());

      // store
      navStore.addEventListener('click', () => {
        setNavActive("store");
        setStoreTab("themes");
        buildStoreUI();
        showOnly(storePanel);
      });
      btnStoreClose.addEventListener('click', () => { showOnly(menuPanel); setNavActive("play"); });
      tabThemes.addEventListener('click', () => setStoreTab("themes"));
      tabTrails.addEventListener('click', () => setStoreTab("trails"));
      btnRecharge.addEventListener('click', () => showOnly(rechargePanel));
      btnRechargeClose.addEventListener('click', () => showOnly(storePanel));

      rechargePanel.addEventListener('click', (e) => {
        const btn = e.target.closest("[data-pack]");
        if (!btn) return;
        const pack = btn.getAttribute("data-pack");
        const packs = {
          small: { g: 100, bonus: 0 },
          medium: { g: 500, bonus: 50 },
          large: { g: 2000, bonus: 300 },
        };
        const p = packs[pack];
        grantGems(p.g + p.bonus);
        toast(`+${p.g + p.bonus}‚óÜ`, "combo", 800);
        beep(980, .06, "triangle", .02);
        haptic(18);
      });

      // settings
      navSettings.addEventListener('click', () => {
        setNavActive("settings");
        refreshSettingsUI();
        showOnly(settingsPanel);
      });
      btnSettingsClose.addEventListener('click', () => { showOnly(menuPanel); setNavActive("play"); });

      swSfx.addEventListener('click', () => toggleSwitch("sfx"));
      swMusic.addEventListener('click', () => toggleSwitch("music"));
      swHaptic.addEventListener('click', () => toggleSwitch("haptic"));

      sensRange.addEventListener('input', () => {
        save.settings.sensitivity = Number(sensRange.value);
        sensVal.textContent = `${save.settings.sensitivity.toFixed(2)}x`;
        saveNow();
      });

      btnRestore.addEventListener('click', () => {
        // demo: "restore" grants back ownership of themes if previously purchased (we can't validate IAP here)
        toast("RESTORE (DEMO)", "combo", 700);
        beep(820, .05, "triangle", .02);
      });
      btnCredits.addEventListener('click', () => showOnly(creditsPanel));
      btnCreditsClose.addEventListener('click', () => showOnly(settingsPanel));

      btnWipe.addEventListener('click', () => {
        if (!confirm("Ï†ïÎßêÎ°ú Î™®Îì† Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
        localStorage.removeItem(KEY);
        save = loadSave();
        dayRollover();
        syncHUD();
        toast("SAVE WIPED", "failed", 900);
        showOnly(menuPanel);
      });

      // nav play returns to menu
      navPlay.addEventListener('click', () => {
        setNavActive("play");
        openMenu();
      });

      // milestone actions
      btnMileContinue.addEventListener('click', () => {
        // resume run after milestone
        showOnly(null);
        state.running = true;
        syncHUD();
        toast("LET'S GO!", "combo", 600);
      });
      btnMileShare.addEventListener('click', async () => {
        const text = `I reached Level ${state.level} in Sky Bridge Z! Best: ${save.bestScore}`;
        try {
          await navigator.clipboard.writeText(text);
          toast("SHARE COPIED", "combo", 700);
        } catch (e) {
          prompt("Copy text:", text);
        }
      });

      // ------------------ Menu navigation buttons open panels ------------------
      // open store/settings from menu as well
      document.getElementById("btnRanking").addEventListener("click", () => { buildRankingUI(); showOnly(rankingPanel); });
      document.getElementById("btnDaily").addEventListener("click", () => { buildDailyUI(); showOnly(dailyPanel); });
      document.getElementById("btnInvite").addEventListener("click", () => { refreshInviteUI(); showOnly(invitePanel); });
      document.getElementById("btnCharacters").addEventListener("click", () => { buildCharactersUI(); showOnly(charactersPanel); });

      // ------------------ Helpers ------------------
      function rand(a, b) { return a + Math.random() * (b - a); }
      function degToRad(d) { return d * Math.PI / 180; }

      // ------------------ Boot ------------------
      resize();
      syncHUD();
      render();
      requestAnimationFrame(loop);

      // if tutorial not seen, keep menu; else still show menu initially
    })();
  </script>
</body>

</html>